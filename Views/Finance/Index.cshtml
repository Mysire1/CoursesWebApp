@{
    ViewData["Title"] = "Оплати та фінанси";
}

<h1>Фінанси та оплати</h1>

<form class="row gy-2 mb-4" id="financeFilterForm">
    <div class="col-auto">
        <select class="form-select" id="studentSelect" name="studentId">
            <option value="">Всі студенти</option>
            @if (ViewBag.Students != null)
            {
                foreach (var student in ViewBag.Students)
                {
                    <option value="@student.StudentId">@student.FullName</option>
                }
            }
        </select>
    </div>
    <div class="col-auto">
        <select class="form-select" id="groupSelect" name="groupId">
            <option value="">Всі групи</option>
            @if (ViewBag.Groups != null)
            {
                foreach (var group in ViewBag.Groups)
                {
                    <option value="@group.GroupId">@group.GroupName</option>
                }
            }
        </select>
    </div>
    <div class="col-auto">
        <select class="form-select" id="statusSelect" name="statusType">
            <option value="">Всі статуси</option>
            <option value="fullyPaid">Повністью сплатили</option>
            <option value="notFullyPaid">Є заборгованість</option>
            <option value="debtLess50">Борг &lt; 50%</option>
            <option value="withDeferrals">Відтермінування</option>
            <option value="withDiscounts">Пільги</option>
        </select>
    </div>
    <div class="col-auto">
        <button type="button" class="btn btn-primary" onclick="loadPaymentStatus()">Фільтрувати</button>
    </div>
</form>

<div class="table-responsive mb-4">
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Дата</th>
                <th>Студент</th>
                <th>Група</th>
                <th>Статус</th>
                <th>Дії</th>
            </tr>
        </thead>
        <tbody id="financeTableBody">
            <tr>
                <td colspan="5" class="text-center text-muted">Оберіть фільтр та натисніть "Фільтрувати"</td>
            </tr>
        </tbody>
    </table>
</div>

<h4>Операції зі знижками та надбавками</h4>

<div id="operationMessage" class="alert d-none mb-3" role="alert"></div>

<div class="row mb-3">
    <div class="col-auto">
        <button class="btn btn-warning" onclick="applySmallGroupSurcharge()">Надбавка для малих груп</button>
    </div>
    <div class="col-auto">
        <button class="btn btn-success" onclick="applyLargeGroupDiscount()">Знижка для великих груп</button>
    </div>
</div>

@section Scripts {
    <script>
        function showMessage(message, isError = false) {
            const msgBox = document.getElementById('operationMessage');
            msgBox.className = isError ? 'alert alert-danger mb-3' : 'alert alert-success mb-3';
            msgBox.innerText = message;
            msgBox.classList.remove('d-none');
            
            setTimeout(() => {
                msgBox.classList.add('d-none');
            }, 3000);
        }

        function loadPaymentStatus() {
            const form = document.getElementById('financeFilterForm');
            const formData = new FormData(form);

            fetch('/Finance/PaymentStatus', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Помилка завантаження');
                return response.text();
            })
            .then(html => {
                document.getElementById('financeTableBody').innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('financeTableBody').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger">Не вдалося завантажити дані</td></tr>';
            });
        }

        function applySmallGroupSurcharge() {
            fetch('/Finance/ApplySmallGroupSurcharge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (!response.ok) throw new Error('Помилка сервера');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage(data.message, false);
                    loadPaymentStatus(); 
                } else {
                    showMessage('Помилка: ' + data.message, true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Не вдалося виконати операцію.', true);
            });
        }

        function applyLargeGroupDiscount() {
            fetch('/Finance/ApplyLargeGroupDiscount', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                 if (!response.ok) throw new Error('Помилка сервера');
                 return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage(data.message, false);
                    loadPaymentStatus();
                } else {
                    showMessage('Помилка: ' + data.message, true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Помилка при застосуванні знижки', true);
            });
        }
    </script>
}